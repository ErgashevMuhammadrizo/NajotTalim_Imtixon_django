{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{{ income.source }} - {% trans "Kirim" %}{% endblock %}

{% block extra_css %}
<style>
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
    }
    .amount-badge {
        font-size: 2rem;
        font-weight: 700;
        padding: 1rem 2rem;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    .info-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        margin-bottom: 1.5rem;
    }
    .info-card:hover {
        transform: translateY(-5px);
    }
    .info-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
    }
    .attachment-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid #dee2e6;
    }
    .similar-income {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    .action-buttons .btn {
        min-width: 100px;
    }
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 0.7rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #3b82f6;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="detail-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb breadcrumb-light">
                        <li class="breadcrumb-item">
                            <a href="{% url 'income:list' %}" class="text-light">
                                <i class="fas fa-money-bill-wave me-1"></i>{% trans "Kirimlar" %}
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-light" aria-current="page">
                            {% trans "Kirim ma'lumotlari" %}
                        </li>
                    </ol>
                </nav>
                
                <h1 class="h2 mb-2">{{ income.source }}</h1>
                <p class="mb-0 opacity-75">
                    <i class="fas fa-calendar-alt me-1"></i>
                    {{ income.date|date:"d F Y" }}
                    {% if income.time %}
                    â€¢ {{ income.time|time:"H:i" }}
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="amount-badge d-inline-block">
                    {{ income.amount|floatformat:0|intcomma }} {{ income.get_currency_display }}
                </div>
                {% if income.is_taxable %}
                <div class="text-light mt-2">
                    <small>
                        <i class="fas fa-percentage me-1"></i>
                        {% trans "Soliq" %}: {{ income.tax_amount|floatformat:0|intcomma }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center action-buttons">
                <div>
                    <a href="{% url 'income:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>{% trans "Orqaga" %}
                    </a>
                </div>
                <div class="d-flex gap-2">
                    <a href="javascript:void(0);" onclick="window.openEditModal('{{ income.uuid }}')" 
                       class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>{% trans "Tahrirlash" %}
                    </a>
                    <button type="button" class="btn btn-outline-danger" 
                            onclick="confirmDelete('{{ income.uuid }}', '{{ income.source }}')">
                        <i class="fas fa-trash me-2"></i>{% trans "O'chirish" %}
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="javascript:void(0);"
                                   onclick="duplicateIncome('{{ income.uuid }}')">
                                    <i class="fas fa-copy me-2"></i>{% trans "Nusxalash" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'income:export' %}?ids={{ income.uuid }}&format=pdf">
                                    <i class="fas fa-file-pdf me-2"></i>{% trans "PDF sifatida saqlash" %}
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" 
                                   href="javascript:void(0);"
                                   onclick="confirmDelete('{{ income.uuid }}', '{{ income.source }}')">
                                    <i class="fas fa-trash-alt me-2"></i>{% trans "O'chirish" %}
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Main Information -->
        <div class="col-lg-8">
            <!-- Basic Information Card -->
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>{% trans "Asosiy ma'lumotlar" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Manba" %}</div>
                            <div class="info-value">{{ income.source }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Kategoriya" %}</div>
                            <div>
                                <span class="badge" 
                                      style="background-color: {{ income.category.color }}20; color: {{ income.category.color }}; padding: 0.5rem 1rem;">
                                    <i class="{{ income.category.icon }} me-2"></i>
                                    {{ income.category.name }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Miqdor" %}</div>
                            <div class="info-value h4 text-success">
                                {{ income.amount|floatformat:0|intcomma }} {{ income.get_currency_display }}
                            </div>
                            {% if income.is_taxable %}
                            <div class="mt-1">
                                <small class="text-danger">
                                    <i class="fas fa-percentage me-1"></i>
                                    {% trans "Soliq" %}: {{ income.tax_amount|floatformat:0|intcomma }}
                                </small>
                                <br>
                                <small class="text-success">
                                    <i class="fas fa-calculator me-1"></i>
                                    {% trans "Net" %}: {{ income.net_amount|floatformat:0|intcomma }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Holat" %}</div>
                            <div>
                                {% if income.status == 'received' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    {{ income.get_status_display }}
                                </span>
                                {% elif income.status == 'pending' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ income.get_status_display }}
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times-circle me-1"></i>
                                    {{ income.get_status_display }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "To'lov usuli" %}</div>
                            <div class="info-value">
                                <i class="fas fa-{{ income.payment_method }} me-2"></i>
                                {{ income.get_payment_method_display }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Sana va vaqt" %}</div>
                            <div class="info-value">
                                {{ income.full_datetime }}
                            </div>
                        </div>
                        {% if income.source_obj %}
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Manba obyekti" %}</div>
                            <div class="info-value">
                                {{ income.source_obj.name }}
                                {% if income.source_obj.description %}
                                <br>
                                <small class="text-muted">{{ income.source_obj.description }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% if income.is_recurring %}
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Takrorlanish" %}</div>
                            <div class="info-value">
                                <span class="badge bg-info">
                                    <i class="fas fa-redo me-1"></i>{% trans "Takrorlanuvchi" %}
                                </span>
                                {% if income.next_occurrence %}
                                <div class="mt-1">
                                    <small class="text-muted">
                                        {% trans "Keyingi" %}: {{ income.next_occurrence }}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% if income.is_transfer %}
                        <div class="col-md-6 mb-3">
                            <div class="info-label">{% trans "Turi" %}</div>
                            <div class="info-value">
                                <span class="badge bg-warning">
                                    <i class="fas fa-exchange-alt me-1"></i>
                                    {% trans "Hisoblar orasidagi o'tkazma" %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Description Card -->
            {% if income.description %}
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-align-left me-2"></i>{% trans "Tavsif" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="info-value">
                        {{ income.description|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tags Card -->
            {% if income.tags.all %}
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2"></i>{% trans "Teglar" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for tag in income.tags.all %}
                    <span class="badge bg-light text-dark me-2 mb-2" style="font-size: 1rem; padding: 0.5rem 1rem;">
                        <i class="fas fa-tag me-1"></i>{{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Attachment Card -->
            {% if income.attachment %}
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-paperclip me-2"></i>{% trans "Biriktirilgan fayl" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            {% if income.attachment.name|lower|slice:'-4:' == '.pdf' %}
                            <i class="fas fa-file-pdf fa-3x text-danger"></i>
                            {% elif income.attachment.name|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif' %}
                            <img src="{{ income.attachment.url }}" alt="Attachment" class="attachment-preview">
                            {% elif income.attachment.name|lower|slice:'-4:' in '.doc,.docx' %}
                            <i class="fas fa-file-word fa-3x text-primary"></i>
                            {% elif income.attachment.name|lower|slice:'-4:' in '.xls,.xlsx' %}
                            <i class="fas fa-file-excel fa-3x text-success"></i>
                            {% else %}
                            <i class="fas fa-file fa-3x text-secondary"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h6 class="mb-1">{{ income.attachment_name }}</h6>
                            <small class="text-muted">
                                {{ income.attachment.size|filesizeformat }}
                            </small>
                            <div class="mt-2">
                                <a href="{{ income.attachment.url }}" 
                                   class="btn btn-sm btn-primary me-2" target="_blank">
                                    <i class="fas fa-eye me-1"></i>{% trans "Ko'rish" %}
                                </a>
                                <a href="{{ income.attachment.url }}" 
                                   class="btn btn-sm btn-outline-secondary" download>
                                    <i class="fas fa-download me-1"></i>{% trans "Yuklab olish" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Additional Information -->
        <div class="col-lg-4">
            <!-- Meta Information Card -->
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>{% trans "Meta ma'lumotlar" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="info-label">{% trans "ID" %}</div>
                        <div class="info-value">
                            <code>{{ income.uuid }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="copyToClipboard('{{ income.uuid }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">{% trans "Yaratilgan" %}</div>
                        <div class="info-value">
                            {{ income.created_at|date:"d F Y, H:i" }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="info-label">{% trans "Yangilangan" %}</div>
                        <div class="info-value">
                            {{ income.updated_at|date:"d F Y, H:i" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Incomes Card -->
            {% if similar_incomes %}
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>{% trans "O'xshash kirimlar" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for similar in similar_incomes %}
                    <div class="similar-income">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ similar.source }}</h6>
                                <small class="text-muted">
                                    {{ similar.date|date:"d M Y" }}
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="text-success fw-bold">
                                    {{ similar.amount|floatformat:0|intcomma }}
                                </div>
                                <small class="text-muted">
                                    {{ similar.get_currency_display }}
                                </small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'income:detail' similar.uuid %}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>{% trans "Ko'rish" %}
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Stats Card -->
            <div class="card info-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>{% trans "Statistika" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="info-label">{% trans "Bu oy" %}</div>
                            <div class="info-value text-success">
                                {{ this_month_total|default:0|floatformat:0|intcomma }}
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="info-label">{% trans "Bu yil" %}</div>
                            <div class="info-value text-primary">
                                {{ this_year_total|default:0|floatformat:0|intcomma }}
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="info-label">{% trans "O'rtacha" %}</div>
                            <div class="info-value">
                                {{ avg_amount|default:0|floatformat:0|intcomma }}
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="info-label">{% trans "Jami" %}</div>
                            <div class="info-value fw-bold">
                                {{ total_count|default:0 }}
                            </div>
                        </div>
                    </div>
                    <a href="{% url 'income:stats' %}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-chart-line me-1"></i>{% trans "Batafsil statistika" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>{% trans "O'chirishni Tasdiqlash" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                    <h5 class="mb-2">{% trans "Ushbu kirimni o'chirishni istaysizmi?" %}</h5>
                    <p class="text-muted" id="deleteSource"></p>
                </div>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "Bu amalni qaytarib bo'lmaydi. Barcha ma'lumotlar butunlay o'chiriladi." %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Bekor qilish" %}
                </button>
                <form method="post" action="{% url 'income:delete' income.uuid %}" 
                      id="deleteForm" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>{% trans "O'chirish" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal Container -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>{% trans "Kirimni Tahrirlash" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editFormContainer">
                    <!-- Form will be loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Copy UUID to clipboard
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show success message
            showToast('{% trans "ID nusxalandi!" %}', 'success');
        });
    };
    
    // Delete confirmation
    window.confirmDelete = function(uuid, source) {
        $('#deleteSource').text(`"${source}"`);
        $('#deleteModal').modal('show');
    };
    
    // Open edit modal
    window.openEditModal = function(uuid) {
        $.get(`/income/${uuid}/edit/`, function(data) {
            $('#editFormContainer').html(data.html || data);
            $('#editModal').modal('show');
        });
    };
    
    // Duplicate income
    window.duplicateIncome = function(uuid) {
        if (confirm('{% trans "Ushbu kirimni nusxalashni istaysizmi?" %}')) {
            $.ajax({
                url: `/income/${uuid}/duplicate/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        setTimeout(() => {
                            window.location.href = `/income/${response.new_uuid}/`;
                        }, 1000);
                    } else {
                        showToast(response.message, 'error');
                    }
                }
            });
        }
    };
    
    // Helper function to show toast
    function showToast(message, type = 'success') {
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" 
                 role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Add to container and show
        $('.toast-container').append(toastHtml);
        const toast = new bootstrap.Toast($('#' + toastId)[0]);
        toast.show();
        
        // Remove after hide
        $('#' + toastId).on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
    
    // Auto-close modals on successful form submission
    $('#editModal').on('hidden.bs.modal', function() {
        location.reload();
    });
});
</script>
{% endblock %}