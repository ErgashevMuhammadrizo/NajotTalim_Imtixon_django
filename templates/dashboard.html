{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Boshqaruv paneli" %} | Kirim-Chiqim{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts/dist/apexcharts.css">
<style>
:root {
    --primary-color: #4361ee;
    --income-color: #10b981;
    --expense-color: #ef4444;
    --balance-color: #3b82f6;
    --warning-color: #f59e0b;
    --dark-color: #1e293b;
    --light-color: #f8fafc;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
}

/* Dashboard Layout */
.dashboard-container {
    background: #f1f5f9;
    min-height: calc(100vh - 70px);
    padding: 20px 0;
}

/* Welcome Header */
.welcome-header {
    background: white;
    border-radius: var(--radius-lg);
    padding: 25px 30px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.welcome-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.welcome-text h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--dark-color);
    margin-bottom: 5px;
}

.welcome-text p {
    color: #64748b;
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.date-time {
    font-size: 0.95rem;
}

.currency-switcher {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8fafc;
    padding: 8px 15px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
}

.currency-switcher label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0;
}

.currency-tabs {
    display: flex;
    background: #e2e8f0;
    border-radius: var(--radius-sm);
    padding: 3px;
}

.currency-tab {
    padding: 6px 20px;
    border: none;
    background: none;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 6px;
}

.currency-tab.active {
    background: white;
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.quick-actions {
    display: flex;
    gap: 10px;
}

.btn-quick-action {
    padding: 10px 20px;
    font-weight: 600;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.btn-quick-action:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Main Balance Cards */
.balance-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.balance-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}

.balance-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.balance-card.income {
    border-top: 4px solid var(--income-color);
}

.balance-card.expense {
    border-top: 4px solid var(--expense-color);
}

.balance-card.balance {
    border-top: 4px solid var(--balance-color);
}

.balance-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.balance-title {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.balance-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.balance-icon.income {
    background: linear-gradient(135deg, var(--income-color), #34d399);
}

.balance-icon.expense {
    background: linear-gradient(135deg, var(--expense-color), #f87171);
}

.balance-icon.balance {
    background: linear-gradient(135deg, var(--balance-color), #60a5fa);
}

.balance-amount {
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--dark-color);
    margin-bottom: 10px;
    line-height: 1;
}

.balance-change {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    font-weight: 600;
}

.balance-change.positive {
    color: var(--income-color);
}

.balance-change.negative {
    color: var(--expense-color);
}

/* Chart Section */
.chart-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.period-selector {
    display: flex;
    gap: 5px;
    background: #f8fafc;
    padding: 5px;
    border-radius: var(--radius-sm);
}

.period-btn {
    padding: 6px 15px;
    border: none;
    background: none;
    color: #64748b;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.period-btn.active {
    background: white;
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.chart-container {
    height: 400px;
    position: relative;
}

/* Recent Transactions */
.transactions-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.transaction-filters {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-group {
    display: flex;
    gap: 5px;
    background: #f8fafc;
    padding: 5px;
    border-radius: var(--radius-sm);
}

.filter-btn {
    padding: 6px 15px;
    border: none;
    background: none;
    color: #64748b;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.filter-btn.active {
    background: white;
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.search-box {
    position: relative;
}

.search-box input {
    padding-left: 35px;
    min-width: 200px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
}

/* Transactions Table */
.transactions-table {
    overflow-x: auto;
}

.table {
    margin-bottom: 0;
}

.table th {
    font-weight: 600;
    color: #64748b;
    border-top: none;
    border-bottom: 2px solid var(--border-color);
    padding: 15px 10px;
    white-space: nowrap;
}

.table td {
    padding: 15px 10px;
    vertical-align: middle;
    border-color: var(--border-color);
}

.table tbody tr {
    transition: background-color 0.2s;
}

.table tbody tr:hover {
    background-color: #f8fafc;
}

.transaction-type {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.transaction-type.income {
    background: #d1fae5;
    color: var(--income-color);
}

.transaction-type.expense {
    background: #fee2e2;
    color: var(--expense-color);
}

.transaction-amount {
    font-weight: 700;
    font-size: 1.1rem;
}

.transaction-amount.income {
    color: var(--income-color);
}

.transaction-amount.expense {
    color: var(--expense-color);
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: #f1f5f9;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #475569;
}

.category-icon {
    font-size: 0.9rem;
}

/* Category Breakdown */
.category-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.category-item {
    background: #f8fafc;
    border-radius: var(--radius-md);
    padding: 20px;
    border: 1px solid var(--border-color);
    transition: all 0.3s;
}

.category-item:hover {
    border-color: var(--primary-color);
    transform: translateY(-3px);
    box-shadow: var(--shadow-sm);
}

.category-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.category-icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    color: white;
    font-size: 16px;
}

.category-name {
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
    font-size: 1rem;
}

.category-amount {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 5px 0;
}

.category-percentage {
    font-size: 0.9rem;
    color: #64748b;
    margin-bottom: 10px;
}

.category-progress {
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.category-progress-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 4rem;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 1.2rem;
    color: #64748b;
    margin-bottom: 10px;
}

.empty-text {
    color: #94a3b8;
    margin-bottom: 20px;
}

/* Modal Styles */
.modal-content {
    border-radius: var(--radius-lg);
    border: none;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    border-bottom: 1px solid var(--border-color);
    padding: 20px 30px;
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    border-top: 1px solid var(--border-color);
    padding: 20px 30px;
}

.form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 8px;
}

/* Responsive Design */
@media (max-width: 992px) {
    .welcome-content {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
    }
    
    .currency-switcher {
        justify-content: space-between;
    }
    
    .quick-actions {
        justify-content: center;
    }
    
    .chart-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .chart-controls {
        justify-content: space-between;
    }
}

@media (max-width: 768px) {
    .balance-cards {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .transaction-filters {
        flex-direction: column;
    }
    
    .search-box input {
        min-width: 100%;
    }
    
    .category-grid {
        grid-template-columns: 1fr;
    }
    
    .table {
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    .welcome-header {
        padding: 20px;
    }
    
    .chart-section,
    .transactions-section,
    .category-section {
        padding: 20px;
    }
    
    .balance-amount {
        font-size: 1.8rem;
    }
    
    .period-selector,
    .filter-group {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <!-- Welcome Header -->
        <div class="welcome-header">
            <div class="welcome-content">
                <div class="welcome-text">
                    <h1>{% trans "Xush kelibsiz" %}, {{ user.first_name|default:user.username }}!</h1>
                    <p class="date-time">
                        <span id="currentDate">{% now "l, d F Y" %}</span>
                        <span id="currentTime">{% now "H:i" %}</span>
                    </p>
                </div>
                
                <div class="d-flex flex-column gap-3">
                    <!-- Currency Switcher -->
                    <div class="currency-switcher">
                        <label class="mb-0">{% trans "Valyuta" %}:</label>
                        <div class="currency-tabs">
                            <button class="currency-tab active" data-currency="UZS">UZS</button>
                            <button class="currency-tab" data-currency="USD">USD</button>
                            <button class="currency-tab" data-currency="EUR">EUR</button>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <!-- Tez Kirim tugmasi -->
                        <a href="{% url 'income:create' %}" class="btn btn-success btn-quick-action">
                           <i class="fas fa-plus-circle"></i>
                           {% trans "Tez Kirim" %}
                        </a>
                    
                       <!-- Tez Chiqim tugmasi -->
                       <a href="{% url 'expenses:create' %}" class="btn btn-danger btn-quick-action">
                           <i class="fas fa-minus-circle"></i>
                            {% trans "Tez Chiqim" %}
                        </a>
                    </div>

                </div>
            </div>
        </div>

        <!-- Main Balance Cards -->
        <div class="balance-cards">
            <!-- Total Income -->
            <div class="balance-card income">
                <div class="balance-header">
                    <div>
                        <div class="balance-title">{% trans "Jami Kirim" %}</div>
                        <div class="balance-amount"><span id="totalIncome">0</span> <span id="incomeUnit">UZS</span></div>
                        <div class="balance-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="incomeChange">0%</span>
                        </div>
                    </div>
                    <div class="balance-icon income">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                </div>
            </div>

            <!-- Total Expense -->
            <div class="balance-card expense">
                <div class="balance-header">
                    <div>
                        <div class="balance-title">{% trans "Jami Chiqim" %}</div>
                        <div class="balance-amount"><span id="totalExpense">0</span> <span id="expenseUnit">UZS</span></div>
                        <div class="balance-change negative">
                            <i class="fas fa-arrow-up"></i>
                            <span id="expenseChange">0%</span>
                        </div>
                    </div>
                    <div class="balance-icon expense">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                </div>
            </div>

            <!-- Current Balance -->
            <div class="balance-card balance">
                <div class="balance-header">
                    <div>
                        <div class="balance-title">{% trans "Joriy Balans" %}</div>
                        <div class="balance-amount"><span id="currentBalance">0</span> <span id="balanceUnit">UZS</span></div>
                        <div class="balance-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="balanceChange">0%</span>
                        </div>
                    </div>
                    <div class="balance-icon balance">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line text-primary"></i>
                    {% trans "Kirim va Chiqim Trendi" %}
                </h3>
                <div class="chart-controls">
                    <div class="period-selector">
                        <button class="period-btn active" data-period="7">{% trans "7 kun" %}</button>
                        <button class="period-btn" data-period="30">{% trans "30 kun" %}</button>
                        <button class="period-btn" data-period="90">{% trans "3 oy" %}</button>
                        <button class="period-btn" data-period="365">{% trans "1 yil" %}</button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <div id="mainChart"></div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Recent Transactions -->
            <div class="col-lg-8">
                <div class="transactions-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-history text-primary"></i>
                            {% trans "Oxirgi Tranzaksiyalar" %}
                        </h3>
                        <div class="transaction-filters">
                            <div class="filter-group">
                                <button class="filter-btn active" data-type="all">{% trans "Barchasi" %}</button>
                                <button class="filter-btn" data-type="income">{% trans "Kirim" %}</button>
                                <button class="filter-btn" data-type="expense">{% trans "Chiqim" %}</button>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="transactionSearch" 
                                       placeholder="{% trans "Qidirish..." %}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="transactions-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>{% trans "Sana" %}</th>
                                    <th>{% trans "Kategoriya" %}</th>
                                    <th>{% trans "Turi" %}</th>
                                    <th>{% trans "Izoh" %}</th>
                                    <th class="text-end">{% trans "Summa" %}</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- Transactions will be loaded here -->
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">{% trans "Yuklanmoqda..." %}</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end mt-3">
                        <a href="{% url 'income:list' %}" class="btn btn-outline-primary btn-sm">
                            {% trans "Barchasini ko'rish" %} <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="col-lg-4">
                <div class="category-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-chart-pie text-success"></i>
                            {% trans "Kategoriyalar bo'yicha" %}
                        </h3>
                        <select class="form-select form-select-sm" id="categoryPeriod" style="width: auto;">
                            <option value="month">{% trans "Bu oy" %}</option>
                            <option value="week">{% trans "Bu hafta" %}</option>
                            <option value="year">{% trans "Bu yil" %}</option>
                        </select>
                    </div>
                    
                    <div class="category-grid" id="categoryBreakdown">
                        <!-- Categories will be loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">{% trans "Yuklanmoqda..." %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Income Modal -->
<div class="modal fade" id="addIncomeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle text-success me-2"></i>
                    {% trans "Tez Kirim qo'shish" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickIncomeForm" method="POST" action="{% url 'income:create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Summa" %}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="amount" required step="0.01" min="0">
                            <span class="input-group-text" id="incomeCurrency">UZS</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Kategoriya" %}</label>
                        <select class="form-select" name="category" required>
                            <option value="">{% trans "Kategoriyani tanlang" %}</option>
                            {% for category in income_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Izoh" %}</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Bekor qilish" %}
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>{% trans "Saqlash" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-minus-circle text-danger me-2"></i>
                    {% trans "Tez Chiqim qo'shish" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickExpenseForm" method="POST" action="{% url 'expenses:create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Summa" %}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="amount" required step="0.01" min="0">
                            <span class="input-group-text" id="expenseCurrency">UZS</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Kategoriya" %}</label>
                        <select class="form-select" name="category" required>
                            <option value="">{% trans "Kategoriyani tanlang" %}</option>
                            {% for category in expense_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Izoh" %}</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Bekor qilish" %}
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save me-1"></i>{% trans "Saqlash" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Get language prefix from URL or document
const getLanguagePrefix = () => {
    const pathparts = window.location.pathname.split('/').filter(p => p);
    if (['en', 'uz', 'ru'].includes(pathparts[0])) {
        return '/' + pathparts[0];
    }
    return '';
};

// Global state
const Dashboard = {
    currency: 'UZS',
    period: '30',
    chart: null,
    data: {},
    langPrefix: getLanguagePrefix()
};

// Initialize dashboard
$(document).ready(function() {
    console.log('Dashboard initializing...');
    initDashboard();
    setupEventListeners();
    loadDashboardData();
    startClock();
});

// Initialize dashboard
function initDashboard() {
    console.log('Initializing chart...');
    Dashboard.chart = new ApexCharts(document.querySelector("#mainChart"), {
        series: [
            {
                name: 'Kirim',
                data: []
            },
            {
                name: 'Chiqim',
                data: []
            }
        ],
        chart: {
            type: 'line',
            height: '100%',
            zoom: {
                enabled: false
            },
            toolbar: {
                show: false
            },
            animations: {
                enabled: true,
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 150
                }
            }
        },
        colors: ['#10b981', '#ef4444'],
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        grid: {
            borderColor: '#e2e8f0'
        },
        xaxis: {
            categories: [],
            labels: {
                style: {
                    colors: '#64748b'
                }
            }
        },
        yaxis: {
            labels: {
                formatter: function(value) {
                    return formatAmount(value);
                },
                style: {
                    colors: '#64748b'
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'right'
        },
        tooltip: {
            y: {
                formatter: function(value) {
                    return formatAmount(value) + ' ' + Dashboard.currency;
                }
            }
        }
    });
    
    Dashboard.chart.render();
    console.log('Chart initialized');
}

// Setup event listeners
function setupEventListeners() {
    // Currency switcher
    $('.currency-tab').click(function() {
        const currency = $(this).data('currency');
        switchCurrency(currency);
    });
    
    // Period selector
    $('.period-btn').click(function() {
        $('.period-btn').removeClass('active');
        $(this).addClass('active');
        Dashboard.period = $(this).data('period');
        loadChartData();
    });
    
    // Transaction filters
    $('.filter-btn').click(function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        filterTransactions($(this).data('type'));
    });
    
    // Transaction search
    $('#transactionSearch').on('input', function() {
        searchTransactions($(this).val());
    });
    
    // Category period selector
    $('#categoryPeriod').change(function() {
        loadCategoryData($(this).val());
    });
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const url = `${Dashboard.langPrefix}/expenses/api/dashboard/summary/?currency=${Dashboard.currency}`;
        console.log('Loading dashboard data from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Dashboard data received:', data);
        
        Dashboard.data = data;
        
        updateBalanceCards(data);
        await loadChartData();
        loadTransactions(data.recent_transactions || []);
        await loadCategoryData('month');
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('Ma\'lumotlarni yuklashda xatolik: ' + error.message);
    }
}

// Update balance cards
function updateBalanceCards(data) {
    console.log('Updating balance cards with:', data);
    
    // Total income
    const incomeAmount = formatAmount(data.total_income || 0);
    $('#totalIncome').text(incomeAmount);
    $('#incomeUnit').text(Dashboard.currency);
    $('#incomeChange').text(`${(data.income_change || 0).toFixed(1)}%`);
    
    // Total expense
    const expenseAmount = formatAmount(data.total_expense || 0);
    $('#totalExpense').text(expenseAmount);
    $('#expenseUnit').text(Dashboard.currency);
    $('#expenseChange').text(`${(data.expense_change || 0).toFixed(1)}%`);
    
    // Current balance
    const balanceAmount = formatAmount(data.current_balance || 0);
    $('#currentBalance').text(balanceAmount);
    $('#balanceUnit').text(Dashboard.currency);
    $('#balanceChange').text(`${(data.balance_change || 0).toFixed(1)}%`);
    
    // Update modal currencies
    $('#incomeCurrency').text(Dashboard.currency);
    $('#expenseCurrency').text(Dashboard.currency);
}

// Format amount without currency symbol
function formatAmount(amount) {
    if (typeof amount !== 'number') {
        amount = parseFloat(amount) || 0;
    }
    
    const isUZS = Dashboard.currency === 'UZS';
    const decimals = isUZS ? 0 : 2;
    
    return new Intl.NumberFormat('uz-UZ', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(amount);
}

// Load chart data
async function loadChartData() {
    try {
        const url = `${Dashboard.langPrefix}/expenses/api/dashboard/chart-data/?period=${Dashboard.period}&currency=${Dashboard.currency}`;
        console.log('Loading chart data from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Chart data received:', data);
        
        if (Dashboard.chart) {
            Dashboard.chart.updateSeries([
                {
                    name: 'Kirim',
                    data: data.income_data || []
                },
                {
                    name: 'Chiqim',
                    data: data.expense_data || []
                }
            ]);
            
            Dashboard.chart.updateOptions({
                xaxis: {
                    categories: data.labels || []
                }
            });
        }
        
    } catch (error) {
        console.error('Error loading chart data:', error);
        showError('Chart ma\'lumotlarini yuklashda xatolik');
    }
}

// Load transactions
function loadTransactions(transactions) {
    const tableBody = $('#transactionsTable');
    
    if (!transactions || transactions.length === 0) {
        tableBody.html(`
            <tr>
                <td colspan="5" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-receipt empty-icon"></i>
                        <h5 class="empty-title">Tranzaksiya topilmadi</h5>
                        <p class="empty-text">Birinchi tranzaksiyangizni qo'shing</p>
                    </div>
                </td>
            </tr>
        `);
        return;
    }
    
    let html = '';
    transactions.forEach(transaction => {
        const isIncome = transaction.type === 'income';
        const typeClass = isIncome ? 'income' : 'expense';
        const amountClass = isIncome ? 'income' : 'expense';
        const amountSign = isIncome ? '+' : '-';
        const formattedAmount = formatAmount(transaction.amount);
        
        html += `
            <tr class="transaction-row" data-type="${transaction.type}" data-id="${transaction.id}">
                <td>${formatDate(transaction.date)}</td>
                <td>
                    <span class="category-badge">
                        <i class="${transaction.category_icon || 'fas fa-folder'} category-icon"></i>
                        ${transaction.category_name || 'N/A'}
                    </span>
                </td>
                <td>
                    <span class="transaction-type ${typeClass}">
                        <i class="fas fa-${isIncome ? 'arrow-down' : 'arrow-up'}"></i>
                        ${isIncome ? 'Kirim' : 'Chiqim'}
                    </span>
                </td>
                <td>${transaction.description || ''}</td>
                <td class="text-end">
                    <span class="transaction-amount ${amountClass}">
                        ${amountSign}${formattedAmount} ${Dashboard.currency}
                    </span>
                </td>
            </tr>
        `;
    });
    
    tableBody.html(html);
}

// Load category data
async function loadCategoryData(period) {
    try {
        const url = `${Dashboard.langPrefix}/expenses/api/dashboard/category-stats/?period=${period}&currency=${Dashboard.currency}`;
        console.log('Loading category data from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Category data received:', data);
        
        updateCategoryBreakdown(data);
        
    } catch (error) {
        console.error('Error loading category data:', error);
        showError('Kategoriya ma\'lumotlarini yuklashda xatolik');
    }
}

// Update category breakdown
function updateCategoryBreakdown(categories) {
    const container = $('#categoryBreakdown');
    
    if (!categories || categories.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="fas fa-chart-pie empty-icon"></i>
                <h5 class="empty-title">Ma'lumotlar yo'q</h5>
                <p class="empty-text">Kategoriya statistikasi mavjud emas</p>
            </div>
        `);
        return;
    }
    
    let html = '';
    categories.forEach(category => {
        const percentage = category.percentage || 0;
        const color = category.color || '#3b82f6';
        const formattedAmount = formatAmount(category.total);
        
        html += `
            <div class="category-item">
                <div class="category-header">
                    <div class="category-icon-circle" style="background: ${color};">
                        <i class="${category.icon || 'fas fa-folder'}"></i>
                    </div>
                    <h6 class="category-name">${category.name}</h6>
                </div>
                <div class="category-amount">${formattedAmount} ${Dashboard.currency}</div>
                <div class="category-percentage">${percentage.toFixed(1)}%</div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: ${percentage}%; background: ${color};"></div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

// Filter transactions
function filterTransactions(type) {
    $('.transaction-row').show();
    
    if (type !== 'all') {
        $('.transaction-row').each(function() {
            if ($(this).data('type') !== type) {
                $(this).hide();
            }
        });
    }
}

// Search transactions
function searchTransactions(query) {
    if (!query) {
        $('.transaction-row').show();
        return;
    }
    
    const searchTerm = query.toLowerCase();
    $('.transaction-row').each(function() {
        const row = $(this);
        const text = row.text().toLowerCase();
        row.toggle(text.includes(searchTerm));
    });
}

// Switch currency
async function switchCurrency(currency) {
    // Update UI
    $('.currency-tab').removeClass('active');
    $(`.currency-tab[data-currency="${currency}"]`).addClass('active');
    
    // Update global state
    Dashboard.currency = currency;
    
    try {
        // Reload all data with new currency
        await loadDashboardData();
        
        // Show success message
        showNotification(
            'Valyuta o\'zgartirildi',
            `Barcha ma\'lumotlar ${currency} valyutasida ko\'rsatilmoqda`,
            'success'
        );
        
    } catch (error) {
        console.error('Error switching currency:', error);
        showError('Valyuta o\'zgartirishda xatolik');
    }
}

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
        return 'Bugun';
    } else if (diffDays === 1) {
        return 'Kecha';
    } else if (diffDays < 7) {
        return `${diffDays} kun oldin`;
    } else {
        return date.toLocaleDateString('uz-UZ', {
            day: 'numeric',
            month: 'short'
        });
    }
}

function showNotification(title, message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'warning': 'alert-warning',
        'danger': 'alert-danger',
        'info': 'alert-info'
    }[type];
    
    const alert = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index: 9999; min-width: 300px;">
            <strong>${title}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(alert);
    
    setTimeout(() => {
        alert.alert('close');
    }, 3000);
}

function showError(message) {
    showNotification('Xatolik', message, 'danger');
}

function startClock() {
    function updateClock() {
        const now = new Date();
        
        // Update date
        $('#currentDate').text(now.toLocaleDateString('uz-UZ', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }));
        
        // Update time
        $('#currentTime').text(now.toLocaleTimeString('uz-UZ', {
            hour: '2-digit',
            minute: '2-digit'
        }));
    }
    
    updateClock();
    setInterval(updateClock, 1000);
}
</script>
{% endblock %}